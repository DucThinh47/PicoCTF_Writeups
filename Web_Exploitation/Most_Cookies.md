# Most Cookies

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image337.png?raw=true)

Truy cập website:

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image338.png?raw=true)

Kiểm tra file python được đính kém theo thử thách:

    from flask import Flask, render_template, request, url_for, redirect, make_response, flash, session
    import random
    app = Flask(__name__)
    flag_value = open("./flag").read().rstrip()
    title = "Most Cookies"
    cookie_names = ["snickerdoodle", "chocolate chip", "oatmeal raisin", "gingersnap", "shortbread", "peanut butter", "whoopie pie", "sugar", "molasses", "kiss", "biscotti", "butter", "spritz", "snowball", "drop", "thumbprint", "pinwheel", "wafer", "macaroon", "fortune", "crinkle", "icebox", "gingerbread", "tassie", "lebkuchen", "macaron", "black and white", "white chocolate macadamia"]
    app.secret_key = random.choice(cookie_names)

    @app.route("/")
    def main():
        if session.get("very_auth"):
            check = session["very_auth"]
            if check == "blank":
                return render_template("index.html", title=title)
            else:
                return make_response(redirect("/display"))
        else:
            resp = make_response(redirect("/"))
            session["very_auth"] = "blank"
            return resp

    @app.route("/search", methods=["GET", "POST"])
    def search():
        if "name" in request.form and request.form["name"] in cookie_names:
            resp = make_response(redirect("/display"))
            session["very_auth"] = request.form["name"]
            return resp
        else:
            message = "That doesn't appear to be a valid cookie."
            category = "danger"
            flash(message, category)
            resp = make_response(redirect("/"))
            session["very_auth"] = "blank"
            return resp

    @app.route("/reset")
    def reset():
        resp = make_response(redirect("/"))
        session.pop("very_auth", None)
        return resp

    @app.route("/display", methods=["GET"])
    def flag():
        if session.get("very_auth"):
            check = session["very_auth"]
            if check == "admin":
                resp = make_response(render_template("flag.html", value=flag_value, title=title))
                return resp
            flash("That is a cookie! Not very special though...", "success")
            return render_template("not-flag.html", title=title, cookie_name=session["very_auth"])
        else:
            resp = make_response(redirect("/"))
            session["very_auth"] = "blank"
            return resp

    if __name__ == "__main__":
        app.run()
    
Có thể thấy `secret key` được set một cách ngẫu nhiên:

    cookie_names = ["snickerdoodle", "chocolate chip", "oatmeal raisin", "gingersnap", "shortbread", "peanut butter", "whoopie pie", "sugar", "molasses", "kiss", "biscotti", "butter", "spritz", "snowball", "drop", "thumbprint", "pinwheel", "wafer", "macaroon", "fortune", "crinkle", "icebox", "gingerbread", "tassie", "lebkuchen", "macaron", "black and white", "white chocolate macadamia"]
        app.secret_key = random.choice(cookie_names)

`Secret key` của ứng dụng được sử dụng để ký một `flask session cookie` để không thể sửa đổi. Tuy nhiên, vì tôi biết `secret key` sẽ là một trong những cái tên random kia, tô có thể thử tất cả cho đến khi giải mã thành công cookie.

Kiểm tra web bằng dev tools, tôi đã tìm ra `session cookie`:

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image339.png?raw=true)

=> `Session cookie`: `eyJ2ZXJ5X2F1dGgiOiJibGFuayJ9.aITnWQ.gMnK2-vWhKmKuhk-53Kf_FfEyjc`

Trước tiên thử decode cookie này bằng `JWT.io`:

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image340.png?raw=true)

Trong header có tham số `very_auth` có giá trị đang là `blank`. Tôi tìm được trong script đoạn sau:

    def flag():
            if session.get("very_auth"):
                check = session["very_auth"]
                if check == "admin":
                    resp = make_response(render_template("flag.html", value=flag_value, title=title))
                    return resp
                flash("That is a cookie! Not very special though...", "success")
                return render_template("not-flag.html", title=title, cookie_name=session["very_auth"])
            else:
                resp = make_response(redirect("/"))
                session["very_auth"] = "blank"
                return resp

=> Tôi cần thay đổi giá trị tham số `very_auth` thành `admin` và lưu nó ở trong `session cookie`.

Để unsign `session cookie`, tôi sử dụng [Flask unsign](https://github.com/Paradoxis/Flask-Unsign):

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image341.png?raw=true)

=> Tôi đã tìm ra secret key là `gingersnap`. 

Tiếp theo tôi sẽ tạo session cookie mới với secret key này:

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image342.png?raw=true)

=> Cookie mới: `eyJ2ZXJ5X2F1dGgiOiJhZG1pbiJ9.aIV6kg.TwUgOIgtpp29vXeHjHBFKVkIrmU`. Tôi sẽ thay cookie này vào và refresh website:

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image343.png?raw=true)
