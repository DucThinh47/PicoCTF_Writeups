# Java Code Analysis!?!
![img](52)

### Web page
![img](53)

### Solution

Xem source page: 

![img](54)

=> Chưa thu được nhiều thông tin lắm. 

Dùng lệnh **wget** để download source code mà thử thách cung cấp: 

![img](55)

=> Source code được nén lại và đặt tên là **bookshelf-pico.zip**. 

Giải nén file và thu được folder **userdata**: 

![img](56)

=> Tìm được file **flag.pdf**. Dùng lệnh **xdg-open** (một công cụ tiện ích dùng để mở một file hoặc URL bằng ứng dụng mặc định được liên kết với loại file hoặc giao thức đó) để mở và xem file: 

![img](57)

Nộp flag nhưng đây không phải flag đúng. 

Trở lại web page, login thử với account được thử thách cung cấp: **username: user** và **password: user**:

![img](58)

Trở lại thư mục source code đã tải về và giải nén, sau khi truy cập path **/src/main/resources**, tìm được file **data.sql**: 

![img](59)

=> Phát hiện ra 4 role trên web là Free, Basic, Premium, Admin.

Truy cập Burp Suite và Intercept login request với account được cấp: 

![img](60)

=> Server response 1 chuỗi trông như **JWT Token** của account vừa login: 
*eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJyb2xlIjoiRnJlZSIsImlzcyI6ImJvb2tzaGVsZiIsImV4cCI6MTczNzk4NzUyMSwiaWF0IjoxNzM3MzgyNzIxLCJ1c2VySWQiOjEsImVtYWlsIjoidXNlciJ9.-3aK4Z2hB6aeGKCT0anogpD9GpH741UMtrtY4RcIIHs*

Thử giải mã Token này: 

![img](61)

Vì đã tìm hiểu được web đã sử dụng JWT để xác thực user trong phiên làm việc, cần nghiên cứu các folders như **controllers**, **services** và **security** trong source code: 

Truy cập **/controllers** và xem trong thư mục có gì:

![img](62)

Truy cập **/services** và xem trong thư mục có gì:

![img](63)

Truy cập **/security** và xem trong thư mục có gì: 

![img](64)

Xem thử nội dung file **SecretGenerator.java**:

![img](65)

Đoạn code có vẻ liên quan đến việc tạo và quản lý một **server secret**.

Server secret thường được sử dụng để ký (sign) và xác thực (verify) các token, chẳng hạn như JWT (JSON Web Token).

**1234** có vẻ như sẽ là key để verify signature JWT. Để verify JWT, cần:

- **Giải mã JWT**: Tách JWT thành 3 phần (header, payload, signature).

- **Tạo lại signature**: Sử dụng cùng thuật toán và key (server secret) để tạo lại signature từ header và payload.

- **So sánh signature**: Nếu signature tạo lại khớp với signature trong JWT, token là hợp lệ.

![img](66)

Thay đổi **role** trong payload thành **Admin** để sinh JWT mới:

![img](67)

Trở lại web page, do JWT thường được lưu trong cookies, mở Inspector và kiểm tra cookies. Thay đổi cả JWT vừa thu được khi thay role thành Admin và thay đổi cả payload, sau đó click icon reset trên góc phải để áp dụng thay đổi: 

![img](68)

Refresh lại page: 

![img](69)

**Flag: picoCTF{w34k_jwt_n0t_g00d_ca4d9701}**







